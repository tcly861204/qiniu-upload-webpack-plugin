"use strict";function _classCallCheck(i,e){if(!(i instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(i,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(i,o.key,o)}}function _createClass(i,e,n){return e&&_defineProperties(i.prototype,e),n&&_defineProperties(i,n),i}var qiniu=require("qiniu"),path=require("path"),ora=require("ora"),chalk=require("chalk"),QiniuUploadWebpackPlugin=function(){function o(i){if(_classCallCheck(this,o),!(i&&i.publicPath&&i.accessKey&&i.secretKey&&i.bucket&&i.zone))throw new Error(chalk.red("\u8bf7\u68c0\u67e5\u4f20\u9012\u53c2\u6570\u662f\u5426\u5b8c\u6574\uff01"));this._options=Object.assign({cover:!1},i),this.qiniuAuthenticationConfig={},this.qiniuAuthenticationConfig.mac=new qiniu.auth.digest.Mac(this._options.accessKey,this._options.secretKey);var e=new qiniu.rs.PutPolicy({scope:this._options.bucket});this.qiniuAuthenticationConfig.uploadToken=e.uploadToken(this.qiniuAuthenticationConfig.mac);var n=new qiniu.conf.Config;n.zone=qiniu.zone[this._options.zone],this.qiniuAuthenticationConfig.formUploader=new qiniu.form_up.FormUploader(n)}return _createClass(o,[{key:"apply",value:function(i){var o=this;i.hooks.compilation.tap("QiniuUploadWebpackPlugin",function(i){i.outputOptions.publicPath=o._options.publicPath,o.absolutePath=i.outputOptions.path}),i.hooks.done.tapAsync("QiniuUploadPlugin",function(i,e){e();var n=[];console.log("Start to upload qiniu cloud..."),Object.keys(i.compilation.assets).forEach(function(i){!i||0<=i.indexOf(".html")||n.push(i)}),o.qiniuUploadFile(n,0)})}},{key:"qiniuUploadFile",value:function(o,t,i){var a=this;if(t>=o.length)console.log(chalk.bgGreen(chalk.black(" DONE "))+chalk.green(" Qiniu upload successfully!"));else{var u=o[t],c=u,e=path.join(this.absolutePath||"",u),l=ora("uploading ".concat(c,"...")).start(),n=i||this.qiniuAuthenticationConfig.uploadToken,s=new qiniu.form_up.PutExtra;this.qiniuAuthenticationConfig.formUploader.putFile(n,c,e,s,function(i,e,n){if(i)throw i;200===n.statusCode?(l.succeed("file: ".concat(c," ")+chalk.green("success\uff01")),a.qiniuUploadFile(o,t+1)):!a._options.cover||614!==n.status&&614!==n.statusCode?(l.fail("file\uff1a".concat(c," ")+chalk.red("fail\uff01")),a.qiniuUploadFile(o,t+1)):(l.fail("file\uff1a".concat(c,", Already exists, try to overwrite upload!")),a.qiniuUploadFile(o,t,a.coverUploadFile(u)))})}}},{key:"coverUploadFile",value:function(i){var e={scope:this._options.bucket+":"+i};return new qiniu.rs.PutPolicy(e).uploadToken(this.qiniuAuthenticationConfig.mac)}}]),o}();module.exports=QiniuUploadWebpackPlugin;